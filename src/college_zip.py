import pandas as pd
import numpy as np
import uszipcode
search = uszipcode.SearchEngine()
df = pd.read_csv('data/co_college_locations.csv')
df.columns = df.columns.str.lower()
df['city'] = df.location.str.split(', ', expand=True)[0]
df['state'] = df.location.str.split(', ', expand=True)[1]

def get_zip_data(row):
    try:
        return search.by_city_and_state(city=row.city, state=row.state)
    except:
        return None

def get_zip_info(row):
    try:
        return row[0].zipcode
    except:
        return None

df['zip_data'] = df.apply(get_zip_data, axis=1)
df['zip'] = df['zip_data'].apply(get_zip_info)

zip_code_dict = {'Denver': [80002, 80003, 80004, 80005, 80007, 80010, 80011, 80012, 80013, 80014, 80015, 80016, 80017, 80018,
                           80019, 80020, 80021, 80022, 80023, 80024, 80030, 80031, 80033, 80045, 80101, 80102, 80103, 80104,
                           80105, 80107, 80108, 80109, 80110, 80111, 80112, 80113, 80116, 80117, 80118, 80120, 80121, 80122,
                           80123, 80124, 80125, 80126, 80127, 80128, 80129, 80130, 80131, 80134, 80135, 80136, 80137, 80138,
                           80202, 80203, 80204, 80205, 80206, 80207, 80209, 80210, 80211, 80212, 80214, 80215, 80216, 80218,
                           80219, 80220, 80221, 80222, 80223, 80224, 80226, 80227, 80228, 80229, 80230, 80231, 80232, 80233,
                           80234, 80235, 80236, 80237, 80238, 80239, 80241, 80246, 80247, 80249, 80260, 80264, 80290, 80293,
                           80294, 80401, 80403, 80419, 80420, 80421, 80422, 80425, 80427, 80432, 80433, 80436, 80438, 80439,
                           80440, 80444, 80448, 80449, 80452, 80453, 80454, 80456, 80457, 80465, 80470, 80475, 80476, 80601,
                           80602, 80640, 80820, 80827, 80830, 80835],
                'Boulder': [80510, 80481, 80301, 80302, 80303, 80304, 80305, 80310, 80025, 80516, 80455, 80026, 80501, 80503,
                           80027, 80540, 80466, 80544, 80471],
                'Fort Collins': [80511, 80512, 80513, 80515, 80517, 80521, 80524, 80525, 80526, 80528, 80532, 80535, 80536, 80537,
                                80538, 80545, 80547, 80549],
                'Pueblo': [81001, 81002, 81003, 81004, 81005, 81006, 81007, 81008, 81009, 81010, 81011, 81012, 81019, 81022, 81023,
                           81025, 81069],
                'Greeley': [80504, 80514, 80516, 80520, 80530, 80534, 80542, 80543, 80546, 80550, 80551, 80610, 80611, 80612, 80615,
                            80620, 80621, 80622, 80623, 80624, 80631, 80632, 80633, 80634, 80638, 80639, 80642, 80643, 80644, 80645, 80646,
                            80648, 80650, 80651, 80652, 80729, 80732, 80742, 80754],
                'Grand Junction': [81501, 81502, 81503, 81504, 81505, 81506, 81507, 81520, 81521, 81522, 81523, 81524, 81525, 81526,
                                   81527, 81624, 81630, 81643, 81646],
                'Colorado Springs': [80106, 80132, 80133, 80808, 80809, 80813, 80814, 80816, 80817, 80819, 80829, 80831, 80832, 80833,
                                    80840, 80860, 80863, 80864, 80902, 80903, 80904, 80905, 80906, 80907, 80908, 80909, 80910, 80911,
                                    80913, 80914, 80915, 80916, 80917, 80918, 80919, 80920, 80921, 80922, 80923, 80924, 80925, 80926, 80927,
                                    80928, 80929, 80930, 80938, 80939, 80951]}

zip_rev = {}
for k,v in zip_code_dict.items():
    for zip in v:
        zip_rev.update({zip: k})

def metro(row):
    try:
        metro = zip_rev[int(row)]
    except: metro = None
    return metro

df['metro'] = df['zip'].apply(metro)
df.drop(columns=['zip_data'], inplace=True)
df.to_csv('data/college_location_metro.csv')
